# ===== Nginx reverse proxy example =====
# URL mapping:
#   https://jiguanghuyu.top/qiangchewei        -> frontend
#   https://jiguanghuyu.top/qiangchewei_server -> backend
#   https://www.jiguanghuyu.top/*              -> 301 to non-www

# HTTP redirect to HTTPS
server {
  listen 80;
  server_name jiguanghuyu.top www.jiguanghuyu.top;
  return 301 https://jiguanghuyu.top$request_uri;
}

# HTTPS: www -> non-www
server {
  listen 443 ssl;
  server_name www.jiguanghuyu.top;

  ssl_certificate     /data/ssl/jiguanghuyu.top.pem;
  ssl_certificate_key /data/ssl/jiguanghuyu.top.key;

  return 301 https://jiguanghuyu.top$request_uri;
}

# HTTPS: app entry
server {
  listen 443 ssl;
  server_name jiguanghuyu.top;

  ssl_certificate     /data/ssl/jiguanghuyu.top.pem;
  ssl_certificate_key /data/ssl/jiguanghuyu.top.key;

  location = /qiangchewei {
    return 301 /qiangchewei/;
  }

  location = /qiangchewei_server {
    return 301 /qiangchewei_server/;
  }

  # backend first: /qiangchewei_server/... -> backend
  location /qiangchewei_server/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # remove prefix and pass to backend root
    rewrite ^/qiangchewei_server/?(.*)$ /$1 break;

    # blue:
    proxy_pass http://127.0.0.1:13001;
    # green (switch when发布):
    # proxy_pass http://127.0.0.1:13002;
  }

  # frontend: /qiangchewei/... -> frontend
  location /qiangchewei/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # remove /qiangchewei prefix before passing to frontend container
    # example:
    #   /qiangchewei/            -> /
    #   /qiangchewei/assets/a.js -> /assets/a.js
    rewrite ^/qiangchewei/?(.*)$ /$1 break;

    proxy_pass http://127.0.0.1:18080;
    # green (switch when发布):
    # proxy_pass http://127.0.0.1:18081;
  }
}
