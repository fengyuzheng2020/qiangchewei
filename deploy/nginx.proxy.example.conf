# ===== Nginx reverse proxy example =====
# domain:
#   www.jiguanghuyu.top/qiangchewei        -> frontend
#   www.jiguanghuyu.top/qiangchewei_server -> backend

server {
  listen 80;
  server_name www.jiguanghuyu.top;

  # optional: redirect /qiangchewei to /qiangchewei/
  location = /qiangchewei {
    return 301 /qiangchewei/;
  }

  # backend first: /qiangchewei_server/... -> backend
  location /qiangchewei_server/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # remove prefix and pass to backend root
    rewrite ^/qiangchewei_server/?(.*)$ /$1 break;

    # blue:
    proxy_pass http://127.0.0.1:13001;
    # green (switch when发布):
    # proxy_pass http://127.0.0.1:13002;
  }

  # frontend: /qiangchewei/... -> frontend
  location /qiangchewei/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # keep /qiangchewei prefix (vite base is /qiangchewei/)
    proxy_pass http://127.0.0.1:18080;
    # green (switch when发布):
    # proxy_pass http://127.0.0.1:18081;
  }
}
